# 第 6 章 - 编程实践 - 避免使用全局变量

## 6.1 全局变量带来的问题

### 6.1.1 命名冲突

当脚本中的全局变量和全局函数越来越多时，发生命名冲突的概率也随之增高，即很可能无意间就使用了一个已经声明了的变量。**所有的变量都被定义为局部变量，这样的代码才是最容易维护的。**

### 6.1.2 代码的脆弱性

一个依赖于全局变量的函数即是深耦合于上下文环境中。如果环境发生改变，函数很可能就失效了。

当定义函数的时候，最好尽可能多地将数据置于局部作用域内。在函数内定义的任何 "东西" 都应当采用这种写法。任何来自函数外部的数据都应当以参数形式传进来。

### 6.1.3 难以测试

任何依赖全局变量才能正常工作的函数，只有为其重新创建完整的全局环境才能正确地测试它。事实上，这意味着你除了要管理全局环境的修改，你还要在两个全局环境中管理它们：生产环境和测试环境。保持两者的同步是很消耗成本的，很快你就会发现（代码）可维护性的噩梦才刚刚开始，越到后来越难以理清头绪。

## 6.2 意外的全局变量

有时候，我们会不小心漏了 `var` 而创建了全局变量，为了避免创建意外的全局变量，我们可以使用一些类似 ESLint 的工具，或者在高版本浏览器中直接启用严格模式（"use strict"）。

## 6.3 单全局变量方式

写 JavaScript 不可能不创建全局变量，最佳方法是依赖尽可能少的全局变量，即只创建一个全局变量。

单全局变量模式已经在各种流行的 JavaScript 类库中广泛使用了。比如 jQuery 定义的 `$` 和 jQuery，Underscore 库定义的 `_`，等等。「单全局变量」的意思是 **所创建的这个唯一全局对象名是独一无二的**。

### 6.3.1 命名空间

**命名空间是简单的通过全局对象的单一属性表示的功能性分组**。比如，YUI 就是依照命名空间的思路来管理其代码的，Y.DOM 下的所有方法都是和 DOM 操作有关的，Y.Event 下的所有方法都是和事件相关的，以此类推。

### 6.3.2 模块

另外一种基于单全局变量的扩充方法是使用模块（modules）。模块是一种通用的功能片段，它并没有创建新的全局变量或命名空间。相反，所有的这些代码都存放于一个表示执行一个任务或发布一个接口的单函数中。可以用一个名称来表示这个模块，同样这个模块可以依赖其他模块。

关于模块更多可以学习下 AMD 规范，CommonJS 规范。jQuery 和 Dojo 都可以使用 RequireJS 来加载 AMD 模块。

## 6.4 零全局变量

零全局变量，最常见的情形就是一段不会被其他脚本访问到的完全独立的脚本。

```javascript
(function(win) {
  var doc = win.document;

  // 在这里定义其他变量

  // 其他代码
}(window));
```

只要你的代码需要被其他的代码所依赖，就不能使用这种零全局变量的方式。如果你的代码需要在运行时被不断扩展或修改也不能使用零全局变量的方式。

但是，如果你的脚本非常短，且不需要和其他代码产生交互，可以考虑使用零全局变量的方式来实现代码。
